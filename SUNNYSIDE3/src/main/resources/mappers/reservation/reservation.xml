<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reservation">

	<!-- 검색어 -->
	<sql id="baseCondition">
	<where>
		<choose>
			<when test="'10' == searchDiv">
				TICKET_CODE LIKE '%' || #{searchWord} || '%'
			</when>
			<otherwise></otherwise>
		</choose>
	</where>
	</sql>

	<delete id="do_delete" parameterType="TicketVO">
		DELETE FROM TICKET_HISTORY WHERE TICKET_CODE = #{ticketCode, jdbcType=VARCHAR}
	</delete>
	
	<select id="get_selectOne" parameterType="TicketVO" resultType="TicketVO">
		SELECT
			BRANCH_ID as branchId
			,ROOM_ID as roomId
			,SCREEN_ID as screenId
			,USER_ID as userId
			,MOVIE_ID as movieId
			,SEAT_NUM as seatNum
			,ADULT_CNT as adultCnt
			,PAY_STATE as payState
			,COST as cost
			,TO_CHAR(PAY_DT, 'YYYY-MM-DD HH24:MI:SS') as payDt
			,TO_CHAR(TICKET_DT, 'YYYY-MM-DD HH24:MI:SS') as ticketDt
		FROM
		    TICKET_HISTORY
		WHERE
		    USER_ID = #{userId, jdbcType=VARCHAR}
	</select>
	 
	<select id="do_save" parameterType="TicketVO">
		INSERT INTO TICKET_HISTORY (
			TICKET_CODE
			,BRANCH_ID
			,ROOM_ID
			,SCREEN_ID
			,USER_ID
			,MOVIE_ID
			,SEAT_NUM
			,ADULT_CNT
			,PAY_STATE
			,COST
			,TICKET_DT
		) VALUES (
		    DBMS_RANDOM.STRING('X', 20)
		    ,#{branchId, jdbcType=VARCHAR}
		    ,#{roomId, jdbcType=VARCHAR}
		    ,#{screenId, jdbcType=VARCHAR}
		    ,#{userId, jdbcType=VARCHAR}
		    ,#{movieId, jdbcType=VARCHAR}
		    ,#{seatNum, jdbcType=NUMERIC}
		    ,#{adultCnt, jdbcType=NUMERIC}
		    ,#{payState, jdbcType=NUMERIC}
		    ,#{cost, jdbcType=NUMERIC}
		    ,SYSDATE
		)
	</select>
	
	<update id="do_update" parameterType="TicketVO">
		UPDATE TICKET_HISTORY
		SET
		    BRANCH_ID = #{branchId, jdbcType=VARCHAR}
		   ,ROOM_ID = #{roomId, jdbcType=VARCHAR}
		   ,SCREEN_ID = #{screenId, jdbcType=VARCHAR}
		   ,USER_ID = #{userId, jdbcType=VARCHAR}
		   ,MOVIE_ID = #{movieId, jdbcType=VARCHAR}
		   ,SEAT_NUM = #{seatNum, jdbcType=NUMERIC}
		   ,ADULT_CNT = #{adultCnt, jdbcType=NUMERIC}
		   ,PAY_STATE = #{payState, jdbcType=NUMERIC}
		   ,COST = #{cost, jdbcType=NUMERIC}
		   ,PAY_DT = TO_DATE(#{payDt, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS')
		   ,TICKET_DT = TO_DATE(#{ticketDt, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS')
		WHERE
			TICKET_CODE = #{ticketCode, jdbcType=VARCHAR}
	</update>
	
	<select id="get_retrieve" parameterType="Search" resultType="TicketVO">
		SELECT T.RNUM as num
			  ,T.TICKET_CODE as ticketCode
			  ,T.BRANCH_ID as branchId
			  ,T.ROOM_ID as roomId
			  ,T.SCREEN_ID as screenId
			  ,T.USER_ID as userId
			  ,T.MOVIE_ID as movieId
			  ,T.SEAT_NUM as seatNum
			  ,T.ADULT_CNT as adultCnt
			  ,T.PAY_STATE as payState
			  ,T.COST as cost
			  ,TO_CHAR(T.PAY_DT, 'YYYY-MM-DD HH24:MI:SS') as payDt
			  ,TO_CHAR(T.TICKET_DT, 'YYYY-MM-DD HH24:MI:SS') as ticketDt
		FROM(
		    SELECT ROWNUM AS RNUM, A.*
		    FROM(
		         SELECT *
		         FROM TICKET_HISTORY
		         <include refid="baseCondition"/>
		         ORDER BY TICKET_DT
		        )A
		    WHERE CEIL(ROWNUM/ #{pageSize, jdbcType=VARCHAR} ) = #{pageNum, jdbcType=VARCHAR}
		    )T
	</select>

</mapper>