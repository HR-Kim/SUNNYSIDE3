<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.sunnyside.cart">
	<!-- 
		 do_save   : 장바구니 저장
		 do_delete : 장바구니 삭제
		 do_deleteAll : 장바구니 전체 삭제
	     do_update : 장바구니 수정
	     sumMoney: 장바구니 금액 합계
	     do_retrieve  : 장바구니 목록
	     do_countCart: 장바구니 동일한 상품 레코드 확인
	     do_updateCountCart: 장바구니 상품수량 변경
	   -->
	
<!-- 장바구니 저장(추가) -->
	<insert id="do_save" parameterType="Cart">
	INSERT INTO CART (
			    cart_id,
          		product_nm,
			    user_id,
			    count,
			    product_id				    
			) VALUES (
			    TO_CHAR(SYSDATE,'yyyymmdd')||'-'||to_char((SELECT COUNT(*) FROM CART), 'FM000'),
			    #{productNm,jdbcType=VARCHAR},
			    #{userId,jdbcType=VARCHAR},
			    #{count,jdbcType=NUMERIC},
			    #{productId,jdbcType=VARCHAR}
			)		
	</insert>
	
<!-- 장바구니 삭제 -->
	<delete id="do_delete"  parameterType="Cart">
		DELETE
		FROM CART
		WHERE CART_ID    = #{cartId,jdbcType=VARCHAR}
	</delete>

<!-- 장바구니 전체 삭제 -->
	<delete id="do_deleteAll">
		DELETE 
		FROM CART
	
	</delete>

<!-- 장바구니 수정 -->
	<update id="do_update"  parameterType="Cart">
		UPDATE cart
		SET
		    count = #{count,jdbcType=NUMERIC}
		WHERE
			product_id =  #{productId,jdbcType=VARCHAR}
		    AND user_id =  #{userId,jdbcType=VARCHAR}
		     
	</update>

<!-- 장바구니 금액 합계 -->
	<select id="do_selectOne" parameterType="Cart" resultType="Cart">
		SELECT
		    NVL(SUM(b.product_cost*count),0) productCost
		FROM
		   		 cart a , product b
		WHERE a.product_id = b.product_id 
		AND a.user_id = #{userId,jdbcType=VARCHAR}	
	</select>
	
<!-- 장바구니 목록 -->
	<select id="do_retrieve" parameterType="Cart" resultType="Cart" >
	 	SELECT
		    a.cart_id as cartId,
		    c.product_nm as productNm,
		    b.user_id as userId,
		    a.count,
		    a.product_cost as productCost,
		    c.product_id as productId,
		    c.save_file_nm as saveFileNm
		FROM
		    cart a, user_info b, product c 
		WHERE
		    b.user_id = a.user_id
		    AND c.product_id = a.product_id
		    AND a.user_id = #{userId,jdbcType=VARCHAR}
		ORDER BY
		    a.cart_id 
	</select>

<!-- 장바구니 동일한 상품 레코드 확인 -->
	<select id="do_countCart" resultType="int">
		SELECT
		    COUNT(*)
		FROM
		    cart
		WHERE 
		    user_id =#{userId,jdbcType=VARCHAR}
		AND product_id = #{productId,jdbcType=VARCHAR}
	</select>

<!-- 장바구니 상품수량 변경 -->
	<update id="do_updateCountCart" parameterType="Cart">
		UPDATE cart	
		SET count = count + #{count} 
		WHERE user_id= #{userId,jdbcType=VARCHAR}
		AND product_id = #{productId,jdbcType=VARCHAR}
	</update>
</mapper>